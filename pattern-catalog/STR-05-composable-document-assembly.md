# Composable Document Assembly

**分类**：结构模式
**必要性**：推荐

## 问题

如何生成超出AI上下文窗口限制的长文档？

长篇报告（如几万字的研究报告）无法在单次AI调用中完整生成。即使能生成，质量也会随着长度增加而下降。常见的错误做法是让AI"一口气"生成整个文档，结果要么超出上下文限制失败，要么后半部分质量严重下滑。

## 语境

该模式适用于以下场景：

- 最终产出是长篇文档（报告、论文、手册等）
- 文档有清晰的章节结构
- 需要转换为其他格式（如通过pandoc生成PDF）
- 对格式一致性有要求

## 作用力

- **完整性 vs 上下文限制**：长文档超出AI处理能力
- **质量 vs 长度**：单次生成越长，后半部分质量越差
- **独立生成 vs 格式一致**：分段生成容易格式不统一
- **灵活性 vs 规范性**：过于严格的规范限制表达，过于宽松则拼接出错

## 解决方案

**将长文档拆分为独立章节，每个章节由独立subagent生成，遵循严格的格式规范，最后用脚本机械拼接。完整文档从不进入AI上下文。**

### 核心原则

1. **分章节独立生成**
   - 每个章节是一个独立的subagent任务
   - 遵循 [Faithful Agent Instantiation](./BHV-02-faithful-agent-instantiation.md)，每章节独立调用
   - 章节之间不需要AI"记住"前面的内容

2. **严格的格式规范**
   - 所有章节遵循相同的格式规范
   - 规范必须具体、可检查，不能是模糊的"要注意格式"
   - 规范要考虑下游工具（如pandoc）的要求

3. **机械拼接**
   - 用shell脚本拼接，不经过AI
   - 拼接逻辑简单可靠：`cat` 各章节文件
   - 完整文档从不需要进入AI上下文

4. **格式规范可复用**
   - 格式规范作为独立文件，被各章节Blueprint引用
   - 修改规范只需改一处

## 结果

### 收益

- **突破上下文限制**：任意长度的文档都可以生成
- **质量一致**：每个章节都得到充分的"注意力"
- **可并行**：多个章节可以并行生成
- **易于修改**：只需重新生成有问题的章节
- **格式可靠**：拼接后的文档格式正确

### 代价

- **需要预先规划结构**：必须先确定章节划分
- **格式规范的维护**：需要制定和维护详细规范
- **灵活性受限**：章节之间的交叉引用需要额外处理

## 实现指南

### 目录结构

```
data/
├── 04.sections/              # 各章节独立文件
│   ├── 00.frontmatter.md     # 封面、摘要等
│   ├── 01.introduction.md
│   ├── 02.chapter1.md
│   ├── 03.chapter2.md
│   └── ...
├── 05.report/
│   └── full_report.md        # 拼接后的完整报告
└── scripts/
    └── assemble.sh           # 拼接脚本
```

### Markdown格式规范（针对pandoc）

以下规范应作为独立文件（如 `references/markdown-format-spec.md`），在各章节生成Agent的Blueprint中引用：

```markdown
## Markdown格式规范

本规范确保各章节可正确拼接，且能被pandoc正确处理。

### 标题规范

- [ ] 章节以二级标题（##）开头，不使用一级标题
- [ ] 一级标题仅用于最终报告的总标题（在frontmatter中）
- [ ] 标题层级连续，不跳级（##后面是###，不能直接跳到####）

### 空行规范

- [ ] 文件开头：一个空行
- [ ] 文件结尾：一个空行
- [ ] 标题前：一个空行
- [ ] 标题后：一个空行
- [ ] 段落之间：一个空行

### 列表规范

- [ ] bullet list 前：必须有一个空行
- [ ] bullet list 后：必须有一个空行
- [ ] 嵌套列表：使用2个空格缩进
- [ ] 列表项内换行：使用2个空格缩进续行

### 代码块规范

- [ ] 代码块前：一个空行
- [ ] 代码块后：一个空行
- [ ] 使用三个反引号，指定语言

### 引用块规范

- [ ] 引用块前：一个空行
- [ ] 引用块后：一个空行
- [ ] 多行引用每行都以 > 开头

### 表格规范

- [ ] 表格前：一个空行
- [ ] 表格后：一个空行
- [ ] 使用标准markdown表格语法

### 特殊字符

- [ ] 避免使用可能导致pandoc解析问题的特殊字符
- [ ] 如需使用特殊字符，使用HTML实体或转义
```

### 拼接脚本示例

```bash
#!/bin/bash
# assemble.sh - 拼接各章节为完整报告

OUTPUT_DIR="data/05.report"
SECTIONS_DIR="data/04.sections"
OUTPUT_FILE="$OUTPUT_DIR/full_report.md"

# 确保输出目录存在
mkdir -p "$OUTPUT_DIR"

# 清空或创建输出文件
> "$OUTPUT_FILE"

# 按顺序拼接各章节
for section in "$SECTIONS_DIR"/*.md; do
    if [ -f "$section" ]; then
        cat "$section" >> "$OUTPUT_FILE"
        # 确保章节之间有空行
        echo "" >> "$OUTPUT_FILE"
    fi
done

echo "报告已生成: $OUTPUT_FILE"
```

### 章节生成Agent Blueprint示例

```markdown
# Section Writer Agent

## 你的任务

为研究报告生成指定章节。

## 输入

- 章节编号和标题
- 该章节应涵盖的分析材料（来自 data/03.analysis/）
- 格式规范（见 references/markdown-format-spec.md）

## 输出

将生成的章节写入 `data/04.sections/{章节编号}.{章节名}.md`

## 格式要求

**严格遵循 `references/markdown-format-spec.md` 中的所有规范。**

特别注意：
1. 章节以二级标题（##）开头
2. 文件开头和结尾各有一个空行
3. 所有列表前后都有空行
4. 不使用一级标题

## 质量标准

- 内容完整覆盖指定的分析材料
- 论述清晰、逻辑连贯
- 引用准确，标注来源编号
```

### Orchestrator中的调用方式

```markdown
## 阶段四：报告生成

### 4.1 确定章节结构

根据分析结果，确定报告的章节划分：
- 00.frontmatter.md: 封面、摘要
- 01.introduction.md: 引言
- 02.xxx.md: 第一章
- ...

### 4.2 生成各章节

对于每个章节，启动独立的subagent：

> 请阅读 `agents/04.section_writer.md` 并严格按照该Blueprint执行。
>
> 参数：
> - SECTION_ID: 02
> - SECTION_TITLE: xxx
> - SOURCE_MATERIALS: data/03.analysis/xxx.md

**重要**：
- 每个章节启动独立的subagent
- 可以并行生成以提高效率
- 每个subagent必须阅读格式规范

### 4.3 拼接报告

所有章节生成完成后，运行拼接脚本：

```bash
bash data/scripts/assemble.sh
```

### 4.4 格式检查

拼接后，检查完整报告的格式：
- 标题层级是否正确
- 是否有格式错乱
- 用pandoc试转换，检查是否有警告
```

## 示例

### 正确示例：章节格式

```markdown

## 新能源汽车产业的政策支持体系

本章分析新能源汽车产业发展过程中的政策支持体系...

### 中央层面的产业政策

根据[SRC-012]的资料，2009年"十城千辆"工程启动...

政策工具主要包括：

- 购置补贴
- 税收优惠
- 牌照便利

### 地方配套政策

各地方政府积极响应中央政策...

```

注意：
- 以二级标题开头
- 开头有空行
- 列表前后有空行
- 结尾有空行

### 错误示例：常见格式问题

```markdown
# 新能源汽车产业的政策支持体系    ❌ 使用了一级标题

本章分析新能源汽车产业发展...
政策工具主要包括：               ❌ 列表前没有空行
- 购置补贴
- 税收优惠
各地方政府积极响应...            ❌ 列表后没有空行
```

### 拼接后的问题排查

| 问题现象 | 可能原因 | 解决方法 |
|----------|----------|----------|
| 标题层级混乱 | 某章节使用了一级标题 | 检查并修正该章节 |
| 列表显示为纯文本 | 列表前没有空行 | 在列表前添加空行 |
| 章节之间没有分隔 | 章节文件结尾没有空行 | 检查拼接脚本是否添加空行 |
| pandoc转换警告 | 特殊字符或格式问题 | 根据警告定位并修复 |

## 相关模式

- **[Faithful Agent Instantiation](./BHV-02-faithful-agent-instantiation.md)**：每个章节独立subagent调用
- **[Filesystem Data Bus](./STR-02-filesystem-data-bus.md)**：章节文件作为中间产物存储
- **[Embedded Quality Standards](./QUA-01-embedded-quality-standards.md)**：格式规范嵌入Blueprint
- **[Business-Driven Agent Design](./STR-04-business-driven-agent-design.md)**：章节生成作为独立业务步骤

## 检查清单

设计长文档生成流程时，确认以下要点：

- [ ] 文档是否已拆分为可独立生成的章节？
- [ ] 是否有独立的格式规范文件？
- [ ] 格式规范是否足够具体（可检查的checklist）？
- [ ] 章节生成Blueprint是否引用了格式规范？
- [ ] 是否有拼接脚本？
- [ ] 拼接脚本是否处理了章节间的空行？
- [ ] 是否考虑了下游工具（如pandoc）的要求？
- [ ] 是否有格式检查步骤？
